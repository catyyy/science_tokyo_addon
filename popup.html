<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="cropper.min.css">
    <style>
        body { width: 400px; padding: 20px; font-family: 'Segoe UI', sans-serif; background: #f9f9f9; min-height: 450px; }
        
        /* è§†å›¾æ§åˆ¶ */
        .view-container { display: none; animation: fadeIn 0.3s; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h3 { margin-top: 0; text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; font-weight: bold; display: block; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; box-shadow: 0 4px 8px rgba(33,150,243,0.3); }
        .btn-secondary { background: #fff; color: #555; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-danger { background: #ff5252; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        
        /* é€‰æ‹©å¡ç‰‡ */
        .choice-card {
            background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 20px; text-align: center; cursor: pointer; margin-bottom: 15px;
            transition: all 0.2s;
        }
        .choice-card:hover { border-color: #2196F3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .choice-icon { font-size: 28px; margin-bottom: 5px; }
        .choice-title { font-weight: bold; color: #333; }
        .choice-desc { font-size: 12px; color: #888; margin-top: 3px; }

        /* è¾“å…¥æ¡† */
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 13px; }

        /* ================= æ‹ŸçœŸå­¦ç”Ÿè¯æ ·å¼ ================= */
        .student-card {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            border: 2px solid #999;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 10px 0;
        }
        
        .matrix-section {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* åˆ—æ ‡ç­¾ A-J */
        .col-labels {
            display: grid;
            grid-template-columns: 20px repeat(10, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }
        
        .col-label {
            text-align: center;
            font-weight: bold;
            font-size: 9px;
            color: white;
            background: #333;
            padding: 2px 0;
            border-radius: 1px;
        }
        
        /* ç¬¬ä¸€ä¸ªç©ºæ ¼å­å ä½ */
        .col-labels::before {
            content: '';
            grid-column: 1;
        }
        
        /* çŸ©é˜µè¡¨æ ¼ */
        .matrix-table {
            display: flex;
            flex-direction: column;
            gap: 0px; /* ç§»é™¤è¡Œé—´è· */
        }
        
        .matrix-row {
            display: grid;
            grid-template-columns: 20px 1fr;
            gap: 1px;
            align-items: stretch;
        }
        
        /* è¡Œæ ‡ç­¾ 1-7 */
        .row-label {
            background: #333;
            color: white;
            font-weight: bold;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1px;
            height: 20px; /* ä¸æ ¼å­é«˜åº¦å®Œå…¨ä¸€è‡´ */
        }
        
        /* å•è¡Œçš„æ ¼å­å®¹å™¨ */
        .matrix-cells {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 1px;
        }
        
        /* å•ä¸ªè¾“å…¥æ ¼å­ - æ‰å¹³ç´§å‡‘æ ·å¼ */
        .matrix-cell-input {
            height: 20px; /* ä»24pxé™ä½åˆ°20px */
            min-width: 0; /* å…è®¸å‹ç¼© */
            text-align: center;
            border: 1px solid #ccc;
            text-transform: uppercase;
            border-radius: 2px;
            font-size: 11px;
            font-weight: bold;
            padding: 0 2px;
            background: white; /* é»˜è®¤ç™½è‰² */
            color: #333;
        }
        
        /* ç²‰ç™½äº¤æ›¿æ£‹ç›˜æ ¼æ•ˆæœ - æŒ‰è¡Œäº¤æ›¿ */
        .matrix-row:nth-child(odd) .matrix-cell-input {
            background: #fce4ec; /* å¥‡æ•°è¡Œ(1,3,5,7)ç²‰è‰² */
        }
        
        .matrix-row:nth-child(even) .matrix-cell-input {
            background: white; /* å¶æ•°è¡Œ(2,4,6)ç™½è‰² */
        }
        
        .matrix-cell-input:focus {
            border-color: #2196F3;
            background: #e3f2fd !important;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        /* åº•éƒ¨å¯¼èˆªæŒ‰é’®ç»„ */
        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }

        /* ================= è£å‰ªä¸OCR æ ¸å¿ƒæ ·å¼ ================= */
        
        /* è£å‰ªå®¹å™¨ï¼šå›ºå®šé«˜åº¦ï¼Œæ·±è‰²èƒŒæ™¯ */
        #crop-container {
            width: 100%;
            height: 350px; /* å›ºå®šé«˜åº¦ç¡®ä¿è£å‰ªæ¡†ç¨³å®š */
            background: #333;
            margin-bottom: 15px;
            display: none; /* é»˜è®¤éšè— */
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }
        
        /* ç½‘æ ¼è¦†ç›–å±‚ */
        #grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1000;
        }

        /* å¾…è£å‰ªå›¾ç‰‡ï¼šåªé™åˆ¶å®½ï¼Œä¸é™åˆ¶é«˜(ç”±å®¹å™¨è£å‰ª) */
        #image-to-crop {
            display: block;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Cropper å¿…é¡»çš„éšè—ç±» */
        .cropper-hidden {
            display: none !important;
        }

        /* è£å‰ªé¢„è§ˆ/è°ƒè¯•åŒºåŸŸ (æ–°å¢) */
        #debug-preview-container {
            text-align: center;
            margin: 10px 0;
            display: none;
            border: 2px dashed #FF9800;
            background: #fff3e0;
            padding: 10px;
            border-radius: 6px;
        }
        #crop-preview {
            max-width: 100%;
            max-height: 150px; /* é™åˆ¶é¢„è§ˆå›¾é«˜åº¦ */
            display: block;
            margin: 5px auto;
            border: 1px solid #ccc;
        }
        .debug-hint { font-size: 12px; color: #E65100; font-weight: bold; margin-bottom: 5px; }

        /* è¿›åº¦æ¡ */
        #ocr-progress { height: 6px; background: #ddd; border-radius: 3px; margin-top: 15px; display: none; overflow: hidden;}
        #ocr-bar { height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s; }
        .status-text { text-align: center; font-size: 12px; color: #666; margin-top: 10px; min-height: 18px; }

        /* ================= å¼ºåˆ¶è¦†ç›– Cropper CSS (é˜²æ­¢æ–‡ä»¶åŠ è½½å¤±è´¥) ================= */
        .cropper-container{direction:ltr;font-size:0;line-height:0;position:relative;-ms-touch-action:none;touch-action:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .cropper-container img{display:block;min-width:0!important;max-width:none!important;min-height:0!important;max-height:none!important;width:100%;height:100%;image-orientation:0deg}
        .cropper-wrap-box,.cropper-canvas,.cropper-drag-box,.cropper-crop-box,.cropper-modal{position:absolute;top:0;right:0;bottom:0;left:0}
        .cropper-drag-box{background-color:#fff;opacity:0}
        .cropper-modal{background-color:#000;opacity:.5}
        .cropper-view-box{display:block;overflow:hidden;width:100%;height:100%;outline:1px solid #39f;outline-color:rgba(51,153,255,.75)}
        .cropper-dashed{border:0 dashed #eee;display:block;opacity:.5;position:absolute}
        .cropper-dashed.dashed-h{border-bottom-width:1px;left:0;top:33.33333%;width:100%;height:0}
        .cropper-dashed.dashed-v{border-right-width:1px;left:33.33333%;top:0;width:0;height:100%}
        .cropper-center{display:none!important}
        .cropper-center:before,.cropper-center:after{background-color:#eee;content:" ";display:block;position:absolute}
        .cropper-center:before{height:1px;left:-3px;top:0;width:7px}
        .cropper-center:after{height:7px;left:0;top:-3px;width:1px}
        .cropper-face,.cropper-line,.cropper-point{display:block;height:100%;opacity:.1;position:absolute;width:100%}
        .cropper-point{background-color:#39f;height:5px;opacity:.75;width:5px}
        .cropper-point.point-e{cursor:ew-resize;margin-top:-3px;right:-3px;top:50%}
        .cropper-point.point-n{cursor:ns-resize;left:50%;margin-left:-3px;top:-3px}
        .cropper-point.point-w{cursor:ew-resize;left:-3px;margin-top:-3px;top:50%}
        .cropper-point.point-s{cursor:ns-resize;bottom:-3px;left:50%;margin-left:-3px}
        .cropper-point.point-ne{cursor:nesw-resize;right:-3px;top:-3px}
        .cropper-point.point-nw{cursor:nwse-resize;left:-3px;top:-3px}
        .cropper-point.point-sw{cursor:nesw-resize;bottom:-3px;left:-3px}
        .cropper-point.point-se{cursor:nwse-resize;bottom:-3px;right:-3px}
    </style>
</head>
<body>

    <div id="view-home" class="view-container active">
        <!-- è¯­è¨€é€‰æ‹©ä¸‹æ‹‰æ¡† -->
        <div style="position: absolute; top: 15px; right: 15px;">
            <select id="language-select" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; cursor: pointer;">
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="zh">ä¸­æ–‡</option>
                <option value="en">English</option>
            </select>
        </div>
        
        <h3 data-i18n="app_title">æ±äº¬ç§‘å­¦å¤§å­¦ç†å·¥å­¦ç³»Portalè‡ªå‹•èªè¨¼</h3>
        
        <div style="padding: 20px 0;">
            <button class="btn btn-primary" id="btn-home-new" data-i18n="btn_new">â• æ–°è¦ä½œæˆ / ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn btn-secondary" id="btn-home-edit" data-i18n="btn_edit">âœï¸ æ—¢å­˜ã®è¨­å®šã‚’ç·¨é›†</button>
        </div>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px;">
             <button class="btn btn-danger" id="btn-home-clear" data-i18n="btn_clear" style="font-size: 12px; width: auto; margin: 0 auto; padding: 8px 15px;">ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»</button>
        </div>
    </div>

    <div id="view-step1" class="view-container">
        <h3 data-i18n="account_info">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
        <label data-i18n="student_id">å­¦ç±ç•ªå· (Student ID)</label>
        <input type="text" id="username" data-i18n-placeholder="username_placeholder" placeholder="ä¾‹: 23B12345">
        
        <label data-i18n="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (Password)</label>
        <input type="password" id="password" data-i18n-placeholder="password_placeholder" placeholder="Portal Password">
        
        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-home" data-i18n="btn_back_home">â¬… ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            <button class="btn btn-primary" id="goto-choice" data-i18n="btn_next">æ¬¡ã¸ â¡</button>
        </div>
    </div>

    <div id="view-choice" class="view-container">
        <h3 data-i18n="choose_input_method">ãƒãƒˆãƒªã‚¯ã‚¹å…¥åŠ›æ–¹å¼ã‚’é¸æŠ</h3>
        
        <div class="choice-card" id="card-ocr">
            <div class="choice-icon">ğŸ“¸</div>
            <div class="choice-title" data-i18n="ocr_title">å†™çœŸè‡ªå‹•èªè­˜ï¼ˆæ¨å¥¨ï¼‰</div>
            <div class="choice-desc" data-i18n="ocr_desc">å­¦ç”Ÿè¨¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ ãƒˆãƒªãƒŸãƒ³ã‚° â†’ è‡ªå‹•èª­å–</div>
        </div>

        <div class="choice-card" id="card-manual">
            <div class="choice-icon">âŒ¨ï¸</div>
            <div class="choice-title" data-i18n="manual_title">æ‰‹å‹•å…¥åŠ›</div>
            <div class="choice-desc" data-i18n="manual_desc">70æ–‡å­—ã‚’æ‰‹å‹•ã§ä¸€ã¤ãšã¤å…¥åŠ›</div>
        </div>

        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-step1" data-i18n="btn_back">â¬… å‰ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="view-ocr" class="view-container">
        <h3 data-i18n="image_processing">ç”»åƒå‡¦ç†</h3>
        
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        
        <button class="btn btn-secondary" id="btn-select-file" data-i18n="btn_select_photo">ğŸ“‚ å†™çœŸã‚’é¸æŠï¼ˆè£é¢ï¼‰</button>

        <div id="crop-container">
            <canvas id="grid-overlay"></canvas>
            <img id="image-to-crop" src="">
        </div>
        
        <div id="crop-hint" style="text-align:center; font-size:12px; color:#666; display:none; margin-bottom: 10px;">
            <span data-i18n="crop_hint">ğŸ’¡ ä½¿ã„æ–¹ï¼šãƒˆãƒªãƒŸãƒ³ã‚°æ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦<strong>ç·‘è‰²ã®ã‚°ãƒªãƒƒãƒ‰</strong>ã‚’70å€‹ã®ãƒã‚¹ã«åˆã‚ã›ã€ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ç”»åƒã‚µã‚¤ã‚ºã‚’èª¿æ•´</span>
        </div>

        <div id="debug-preview-container">
            <div class="debug-hint" data-i18n="preview_hint">ã“ã®é ˜åŸŸã‚’èªè­˜ã—ã¾ã™ï¼š</div>
            <img id="crop-preview">
            <div style="font-size:10px; color:#666;" data-i18n="preview_warning">ä¸è¦ç‰©ãŒå«ã¾ã‚Œã¦ã„ãŸã‚Šã€å‚¾ã„ã¦ã„ã‚‹å ´åˆã¯æˆ»ã£ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„</div>
        </div>

        <div id="ocr-progress"><div id="ocr-bar"></div></div>
        <div id="ocr-status" class="status-text"></div>

        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-choice" data-i18n="btn_back">â¬… å‰ã«æˆ»ã‚‹</button>
            <button class="btn btn-primary" id="btn-confirm-crop" style="display: none;" data-i18n="btn_confirm_crop">âœ‚ ç¢ºèªã—ã¦èªè­˜</button>
        </div>
    </div>

    <div id="view-matrix" class="view-container">
        <h3 data-i18n="confirm_matrix">ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª</h3>
        
        <div id="ocr-confidence-hint" style="font-size: 12px; color: #666; text-align: center; margin-bottom: 10px; display: none;">
            <span data-i18n="confidence_hint">ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼šé»„è‰²=ä¿¡é ¼åº¦ä½ã€èµ¤è‰²=ä¿¡é ¼åº¦æ¥µä½</span>
        </div>
        
        <!-- æ‹ŸçœŸå­¦ç”Ÿè¯æ ·å¼ -->
        <div class="student-card">
            <!-- çŸ©é˜µåŒºåŸŸ -->
            <div class="matrix-section">
                <!-- åˆ—æ ‡ç­¾ A-J -->
                <div class="col-labels">
                    <div class="col-label">A</div>
                    <div class="col-label">B</div>
                    <div class="col-label">C</div>
                    <div class="col-label">D</div>
                    <div class="col-label">E</div>
                    <div class="col-label">F</div>
                    <div class="col-label">G</div>
                    <div class="col-label">H</div>
                    <div class="col-label">I</div>
                    <div class="col-label">J</div>
                </div>
                
                <!-- çŸ©é˜µç½‘æ ¼ï¼ˆ7è¡ŒÃ—10åˆ—ï¼‰ -->
                <div class="matrix-table">
                    <!-- ç¬¬1è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">1</div>
                        <div class="matrix-cells" data-row="0"></div>
                    </div>
                    <!-- ç¬¬2è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">2</div>
                        <div class="matrix-cells" data-row="1"></div>
                    </div>
                    <!-- ç¬¬3è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">3</div>
                        <div class="matrix-cells" data-row="2"></div>
                    </div>
                    <!-- ç¬¬4è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">4</div>
                        <div class="matrix-cells" data-row="3"></div>
                    </div>
                    <!-- ç¬¬5è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">5</div>
                        <div class="matrix-cells" data-row="4"></div>
                    </div>
                    <!-- ç¬¬6è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">6</div>
                        <div class="matrix-cells" data-row="5"></div>
                    </div>
                    <!-- ç¬¬7è¡Œ -->
                    <div class="matrix-row">
                        <div class="row-label">7</div>
                        <div class="matrix-cells" data-row="6"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-ocr" data-i18n="btn_re_recognize">â¬… å†èªè­˜</button>
            <button class="btn btn-primary" id="btn-save-final" data-i18n="btn_save_complete">âœ… ä¿å­˜ã—ã¦å®Œäº†</button>
        </div>
    </div>

    <script src="jquery.min.js"></script>
    <script src="cropper.min.js"></script>
    <script src="tesseract.min.js"></script>
    <script src="popup.js"></script>
</body>
</html>