<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="cropper.min.css">
    <style>
        body { width: 400px; padding: 20px; font-family: 'Segoe UI', sans-serif; background: #f9f9f9; min-height: 450px; }
        
        /* è§†å›¾æ§åˆ¶ */
        .view-container { display: none; animation: fadeIn 0.3s; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h3 { margin-top: 0; text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; font-weight: bold; display: block; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; box-shadow: 0 4px 8px rgba(33,150,243,0.3); }
        .btn-secondary { background: #fff; color: #555; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-danger { background: #ff5252; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        
        /* é€‰æ‹©å¡ç‰‡ */
        .choice-card {
            background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 20px; text-align: center; cursor: pointer; margin-bottom: 15px;
            transition: all 0.2s;
        }
        .choice-card:hover { border-color: #2196F3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .choice-icon { font-size: 28px; margin-bottom: 5px; }
        .choice-title { font-weight: bold; color: #333; }
        .choice-desc { font-size: 12px; color: #888; margin-top: 3px; }

        /* è¾“å…¥æ¡† */
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 13px; }

        /* çŸ©é˜µè¡¨æ ¼ */
        .matrix-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin: 15px 0; }
        .matrix-input { width: 100%; aspect-ratio: 1; text-align: center; border: 1px solid #ccc; text-transform: uppercase; border-radius: 3px; font-size: 12px; padding: 0; }
        .matrix-input:focus { border-color: #2196F3; background: #e3f2fd; outline: none; }

        /* åº•éƒ¨å¯¼èˆªæŒ‰é’®ç»„ */
        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }

        /* ================= è£å‰ªä¸OCR æ ¸å¿ƒæ ·å¼ ================= */
        
        /* è£å‰ªå®¹å™¨ï¼šå›ºå®šé«˜åº¦ï¼Œæ·±è‰²èƒŒæ™¯ */
        #crop-container {
            width: 100%;
            height: 350px; /* å›ºå®šé«˜åº¦ç¡®ä¿è£å‰ªæ¡†ç¨³å®š */
            background: #333;
            margin-bottom: 15px;
            display: none; /* é»˜è®¤éšè— */
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        /* å¾…è£å‰ªå›¾ç‰‡ï¼šåªé™åˆ¶å®½ï¼Œä¸é™åˆ¶é«˜(ç”±å®¹å™¨è£å‰ª) */
        #image-to-crop {
            display: block;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Cropper å¿…é¡»çš„éšè—ç±» */
        .cropper-hidden {
            display: none !important;
        }

        /* è£å‰ªé¢„è§ˆ/è°ƒè¯•åŒºåŸŸ (æ–°å¢) */
        #debug-preview-container {
            text-align: center;
            margin: 10px 0;
            display: none;
            border: 2px dashed #FF9800;
            background: #fff3e0;
            padding: 10px;
            border-radius: 6px;
        }
        #crop-preview {
            max-width: 100%;
            max-height: 150px; /* é™åˆ¶é¢„è§ˆå›¾é«˜åº¦ */
            display: block;
            margin: 5px auto;
            border: 1px solid #ccc;
        }
        .debug-hint { font-size: 12px; color: #E65100; font-weight: bold; margin-bottom: 5px; }

        /* è¿›åº¦æ¡ */
        #ocr-progress { height: 6px; background: #ddd; border-radius: 3px; margin-top: 15px; display: none; overflow: hidden;}
        #ocr-bar { height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s; }
        .status-text { text-align: center; font-size: 12px; color: #666; margin-top: 10px; min-height: 18px; }

        /* ================= å¼ºåˆ¶è¦†ç›– Cropper CSS (é˜²æ­¢æ–‡ä»¶åŠ è½½å¤±è´¥) ================= */
        .cropper-container{direction:ltr;font-size:0;line-height:0;position:relative;-ms-touch-action:none;touch-action:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
        .cropper-container img{display:block;min-width:0!important;max-width:none!important;min-height:0!important;max-height:none!important;width:100%;height:100%;image-orientation:0deg}
        .cropper-wrap-box,.cropper-canvas,.cropper-drag-box,.cropper-crop-box,.cropper-modal{position:absolute;top:0;right:0;bottom:0;left:0}
        .cropper-drag-box{background-color:#fff;opacity:0}
        .cropper-modal{background-color:#000;opacity:.5}
        .cropper-view-box{display:block;overflow:hidden;width:100%;height:100%;outline:1px solid #39f;outline-color:rgba(51,153,255,.75)}
        .cropper-dashed{border:0 dashed #eee;display:block;opacity:.5;position:absolute}
        .cropper-dashed.dashed-h{border-bottom-width:1px;left:0;top:33.33333%;width:100%;height:0}
        .cropper-dashed.dashed-v{border-right-width:1px;left:33.33333%;top:0;width:0;height:100%}
        .cropper-center{display:block;height:0;left:50%;opacity:.75;position:absolute;top:50%;width:0}
        .cropper-center:before,.cropper-center:after{background-color:#eee;content:" ";display:block;position:absolute}
        .cropper-center:before{height:1px;left:-3px;top:0;width:7px}
        .cropper-center:after{height:7px;left:0;top:-3px;width:1px}
        .cropper-face,.cropper-line,.cropper-point{display:block;height:100%;opacity:.1;position:absolute;width:100%}
        .cropper-point{background-color:#39f;height:5px;opacity:.75;width:5px}
        .cropper-point.point-e{cursor:ew-resize;margin-top:-3px;right:-3px;top:50%}
        .cropper-point.point-n{cursor:ns-resize;left:50%;margin-left:-3px;top:-3px}
        .cropper-point.point-w{cursor:ew-resize;left:-3px;margin-top:-3px;top:50%}
        .cropper-point.point-s{cursor:ns-resize;bottom:-3px;left:50%;margin-left:-3px}
        .cropper-point.point-ne{cursor:nesw-resize;right:-3px;top:-3px}
        .cropper-point.point-nw{cursor:nwse-resize;left:-3px;top:-3px}
        .cropper-point.point-sw{cursor:nesw-resize;bottom:-3px;left:-3px}
        .cropper-point.point-se{cursor:nwse-resize;bottom:-3px;right:-3px}
    </style>
</head>
<body>

    <div id="view-home" class="view-container active">
        <h3>ä¸œç§‘å¤§è‡ªåŠ¨è®¤è¯åŠ©æ‰‹</h3>
        <div style="padding: 20px 0;">
            <button class="btn btn-primary" id="btn-home-new">â• æ–°å»º / é‡ç½®é…ç½®</button>
            <button class="btn btn-secondary" id="btn-home-edit">âœï¸ ç¼–è¾‘ç°æœ‰é…ç½®</button>
        </div>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px;">
             <button class="btn btn-danger" id="btn-home-clear" style="font-size: 12px; width: auto; margin: 0 auto; padding: 8px 15px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <div id="view-step1" class="view-container">
        <h3>è´¦å·ä¿¡æ¯</h3>
        <label>å­¦ç±ç•ªå· (Student ID)</label>
        <input type="text" id="username" placeholder="ä¾‹: 23B12345">
        
        <label>å¯†ç  (Password)</label>
        <input type="password" id="password" placeholder="Portal Password">
        
        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-home">è¿”å›</button>
            <button class="btn btn-primary" id="goto-choice">ä¸‹ä¸€æ­¥ â¡</button>
        </div>
    </div>

    <div id="view-choice" class="view-container">
        <h3>é€‰æ‹©çŸ©é˜µè¾“å…¥æ–¹å¼</h3>
        
        <div class="choice-card" id="card-ocr">
            <div class="choice-icon">ğŸ“¸</div>
            <div class="choice-title">æ‹ç…§è‡ªåŠ¨è¯†åˆ« (æ¨è)</div>
            <div class="choice-desc">ä¸Šä¼ å­¦ç”Ÿè¯ -> è£å‰ª -> è‡ªåŠ¨è¯»å–</div>
        </div>

        <div class="choice-card" id="card-manual">
            <div class="choice-icon">âŒ¨ï¸</div>
            <div class="choice-title">æ‰‹åŠ¨è¾“å…¥</div>
            <div class="choice-desc">æ‰‹åŠ¨é€ä¸ªè¾“å…¥ 70 ä¸ªå­—ç¬¦</div>
        </div>

        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-step1">â¬… ä¸Šä¸€æ­¥</button>
        </div>
    </div>

    <div id="view-ocr" class="view-container">
        <h3>å›¾ç‰‡å¤„ç†</h3>
        
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        
        <button class="btn btn-secondary" id="btn-select-file">ğŸ“‚ é€‰æ‹©ç…§ç‰‡ (èƒŒé¢)</button>

        <div id="crop-container">
            <img id="image-to-crop" src="">
        </div>
        
        <div id="crop-hint" style="text-align:center; font-size:12px; color:#666; display:none; margin-bottom: 10px;">
            è¯·æ‹–åŠ¨è£å‰ªæ¡†ï¼Œåªæ¡†é€‰ 7x10 çš„çŸ©é˜µåŒºåŸŸï¼ˆä¸è¦åŒ…å«è¡Œåˆ—å·ï¼‰
        </div>

        <div id="debug-preview-container">
            <div class="debug-hint">å³å°†å¯¹æ­¤åŒºåŸŸè¿›è¡Œè¯†åˆ«ï¼š</div>
            <img id="crop-preview">
            <div style="font-size:10px; color:#666;">å¦‚æœåŒ…å«æ‚ç‰©æˆ–åˆ‡æ­ªäº†ï¼Œè¯·è¿”å›é‡è¯•</div>
        </div>

        <div id="ocr-progress"><div id="ocr-bar"></div></div>
        <div id="ocr-status" class="status-text"></div>

        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-choice">â¬… è¿”å›</button>
            <button class="btn btn-primary" id="btn-confirm-crop" style="display: none;">âœ‚ ç¡®è®¤å¹¶è¯†åˆ«</button>
        </div>
    </div>

    <div id="view-matrix" class="view-container">
        <h3>ç¡®è®¤çŸ©é˜µæ•°æ®</h3>
        
        <div style="font-size: 12px; color: #666; text-align: center; margin-bottom: 5px;">
            è¯·æ ¸å¯¹ä¸‹æ–¹æ•°æ®æ˜¯å¦æ­£ç¡®
        </div>
        
        <div class="matrix-grid" id="grid-container"></div>
        
        <div class="nav-btns">
            <button class="btn btn-secondary" id="back-to-ocr">â¬… é‡æ–°è¯†åˆ«</button>
            <button class="btn btn-primary" id="btn-save-final">âœ… ä¿å­˜å¹¶å®Œæˆ</button>
        </div>
    </div>

    <script src="jquery.min.js"></script>
    <script src="cropper.min.js"></script>
    <script src="tesseract.min.js"></script>
    <script src="popup.js"></script>
</body>
</html>